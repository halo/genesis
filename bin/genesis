#!/bin/sh

# Exit if any command fails
set -e

# Obtain superuser privileges right from the start
sudo echo

# Install Chef if needed
if [ ! -x /opt/chef/bin/chef-solo ]; then
  echo "Installing Chef..."
  curl --location --silent https://omnitruck.chef.io/install.sh | sudo sh > /dev/null
fi

echo "Running Genesis..."
# Chef only knows `/etc/local/bin/brew`, which does not work for Apple Silicon.
# See https://github.com/chef/chef/blob/main/lib/chef/mixin/homebrew_user.rb
# But as long as `brew` is on the PATH, it'll work. So we add it right here.
PATH="$PATH:/opt/homebrew/bin" sudo /opt/chef/bin/chef-solo --chef-license=accept --config $(dirname $(dirname "$0"))/config.rb

YELLOW='\033[0;33m'
CLEAR='\033[0m'

echo -e "Default \e[34mBlue"

echo ""
echo ""
echo ""
echo "${YELLOW}Do not forget to install these profiles manually:${CLEAR}"
echo "${YELLOW}open '/Library/Application Support/io.github.halo.genesis/profiles'${CLEAR}"
echo ""
